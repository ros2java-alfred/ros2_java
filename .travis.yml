# Travis file for ROS2 Java.
# Version 2

sudo: required

language: generic

os:
  - linux
  
services:
  - docker

env:
  global:
    - HOME_BUILD=${HOME}/build
    - ROS2WS=${HOME_BUILD}/ros2_java_ws
    - ROS2JAVA_PATH=${ROS2WS}/src/android-cmake/android-cmake/android.toolchain.cmake
    - PYTHON_PATH=/usr/bin/python3
    - COMMIT=${TRAVIS_COMMIT::8}
    - ENV_PATH=${HOME_BUILD}/.env.txt

cache:
  directories:
    - .autoconf
    - $HOME/.m2
    - $HOME/.gradle

matrix:
  include:
    - os: linux
      env: DOCKER_DIST="ubuntu"
      services:
        - docker
    - os: linux
      env: DOCKER_DIST="debian-stable"
      services:
        - docker
    - os: linux
      env: DOCKER_DIST="ubuntu-rolling"
      services:
        - docker
  allow_failures:
    - os: linux
      env: DOCKER_DIST="debian-stable"
      services:
        - docker
    - os: linux
      env: DOCKER_DIST="ubuntu-rolling"
      services:
        - docker

before_install:
  - docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  - docker pull $DOCKER_REPO:$DOCKER_DIST
  - cd $HOME_BUILD && env | grep -E '^TRAVIS_' > $ENV_PATH && env | grep -E '^COVERALLS_' >> $ENV_PATH && env | grep -E '^CI_' >> $ENV_PATH && echo -e "CI_BUILD_NUMBER=$TRAVIS_BUILD_NUMBER\nCI_PULL_REQUEST=$TRAVIS_PULL_REQUEST\nCI_BRANCH=$TRAVIS_BRANCH\nCI_BUILD_URL=$" >> $ENV_PATH
  - docker run -u "$UID" -it --rm -v `pwd`:`pwd` --env-file $ENV_PATH -w `pwd` $DOCKER_REPO:$DOCKER_DIST sh -c "locale && env | grep -E '^TRAVIS_' && env | grep -E '^CI_' && env | grep -E '^JAVA_'"
  - echo "INSTALL/BUILD ROS2 AMENT..."
  - cd $HOME_BUILD && mkdir -p ament_ws/src && cd $HOME_BUILD/ament_ws
  - docker run -u "$UID" -it --rm -v `pwd`:`pwd` -w `pwd` $DOCKER_REPO:$DOCKER_DIST sh -c "/usr/bin/wget https://gist.githubusercontent.com/Theosakamg/e6084cfafa6b7ea690104424cef970a2/raw/ament_java.repos"
  - docker run -u "$UID" -it --rm -v `pwd`:`pwd` -w `pwd` $DOCKER_REPO:$DOCKER_DIST sh -c "/usr/bin/vcs import src < ament_java.repos"
  - docker run -u "$UID" -it --rm -v `pwd`:`pwd` -w `pwd` $DOCKER_REPO:$DOCKER_DIST sh -c "src/ament/ament_tools/scripts/ament.py build --symlink-install --isolated"
  - echo "INSTALL ROS2 WS..."
  - cd $HOME_BUILD && mkdir -p $ROS2WS/src && cd $ROS2WS
  - docker run -u "$UID" -it --rm -v `pwd`:`pwd` -w `pwd` $DOCKER_REPO:$DOCKER_DIST sh -c "/usr/bin/wget https://gist.githubusercontent.com/Theosakamg/d9259bbc708c5145255fbdeb25e65e19/raw/ros2_java_desktop.repos"
  - docker run -u "$UID" -it --rm -v `pwd`:`pwd` -w `pwd` $DOCKER_REPO:$DOCKER_DIST sh -c "/usr/bin/vcs import src < ros2_java_desktop.repos"
  - cd $ROS2WS/src/ros2/rosidl_typesupport && patch -p1 < ../../ros2_java/ros2_java/rosidl_ros2_java.diff
  - cd $ROS2WS/src/eProsima/Fast-RTPS && git submodule init && git submodule update
  - rm -rf $ROS2WS/src/ros2_java/ros2_java && ln -s $HOME_BUILD/ros2java-alfred/ros2_java  $ROS2WS/src/ros2_java/ros2_java
  - echo "BUILD ROS2 WS..."
  - cd $HOME_BUILD
  - docker run -u "$UID" -it --rm -v `pwd`:`pwd` --env-file $ENV_PATH -w `pwd` $DOCKER_REPO:$DOCKER_DIST sh -c ". ament_ws/install_isolated/local_setup.sh && cd /home/travis/build/ros2_java_ws && ament build --symlink-install --isolated --skip-packages $PKG_EXCLUDE --ament-gradle-args --parallel --daemon --configure-on-demand"

script:
  - cd $HOME_BUILD && docker run -u "$UID" -it --rm -v `pwd`:`pwd` --env-file $ENV_PATH -w `pwd` $DOCKER_REPO:$DOCKER_DIST sh -c ". ament_ws/install_isolated/local_setup.sh && cd /home/travis/build/ros2_java_ws && . ./install_isolated/local_setup.sh && ament test --symlink-install --isolated --only-packages ament_cmake_export_jars rcljava rcljava_common"

after_success:
  - docker run -u "$UID" -it --env-file $ENV_PATH -w `pwd` --name="artefact" $DOCKER_REPO:$DOCKER_DIST sh -c "echo ok"
  - docker cp -L $HOME_BUILD/. artefact:$HOME_BUILD
  - docker commit -m "Build $TRAVIS_BUILD_NUMBER" artefact $DOCKER_REPO:$DOCKER_DIST-ros2java
  - docker push $DOCKER_REPO:$DOCKER_DIST-ros2java
  - 'if [ ${TRAVIS_EVENT_TYPE} != "cron" ]; then
        docker tag $DOCKER_REPO:$DOCKER_DIST-ros2java $DOCKER_REPO:$DOCKER_DIST-ros2java_$TRAVIS_BUILD_NUMBER ;
     fi'
  - 'if [ ${TRAVIS_EVENT_TYPE} != "cron" ]; then
        docker push $DOCKER_REPO:$DOCKER_DIST-ros2java_$TRAVIS_BUILD_NUMBER ;
     fi'

notifications:
  webhooks:
    urls:
      - https://webhooks.gitter.im/e/4aac82b42245203edceb
    on_success: change  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: never     # options: [always|never|change] default: always
